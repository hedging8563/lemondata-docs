---
title: "✨ 上游 Prompt 快取"
description: "了解供應商層級的 Prompt 快取及其如何降低成本"
---

## 概覽

除了 LemonData 的[平台語義快取](/guides/caching)之外，許多 AI 供應商也提供自有的 **Prompt 快取**功能。這是一種運行在供應商層級（Anthropic、OpenAI、DeepSeek 等）的獨立快取機制。

<Note>
**兩種快取類型**

| 類型 | 位置 | 工作原理 | 成本 |
|------|-------|--------------|------|
| **平台快取** | LemonData | 語義相似度匹配 | 正常價格的 20% |
| **供應商快取** | 上游 (Anthropic/OpenAI 等) | 精確前綴匹配 | Token 費率折扣 |

這兩者是**互斥的**：如果平台快取命中，則不會發起上游調用，因此供應商快取不適用。
</Note>

## 供應商 Prompt 快取的工作原理

供應商 Prompt 快取會將 Prompt 前綴的處理結果儲存在供應商的伺服器上。當您發送具有相同前綴的請求時，供應商可以跳過對這些 Token 的重複處理。

### 核心特性

- **基於前綴**：只有 Prompt 的開頭部分可以被快取
- **精確匹配**：要求 Token 完全一致（而非語義相似）
- **有時效性**：快取條目會過期（通常為 5-60 分鐘）
- **自動化**：無需特殊配置

```
請求 1: [系統 Prompt + 上下文 A + 問題 1]
           ^^^^^^^^^^^^^^^^^^^^^^^^
           此前綴被快取

請求 2: [系統 Prompt + 上下文 A + 問題 2]
           ^^^^^^^^^^^^^^^^^^^^^^^^
           快取命中！僅處理問題 2
```

## 支援的供應商

| 供應商 | 快取讀取折扣 | 快取寫入成本 | 最小 Token 數 |
|----------|---------------------|------------------|------------|
| **Anthropic** | 1 折 (90% off) | 與輸入相同 | 1024 |
| **OpenAI** | 5 折 (50% off) | 與輸入相同 | 1024 |
| **DeepSeek** | 1 折 (90% off) | 與輸入相同 | 64 |
| **Google** | 2.5 折 (75% off) | 25% 溢價 | 32768 |

<Info>
折扣會自動應用。LemonData 會將供應商的快取定價直接透傳給您。
</Info>

## 識別快取使用情況

### 在用量日誌中

您的用量日誌顯示了詳細的快取 Token 細分：

| 欄位 | 描述 |
|-------|-------------|
| `cacheReadTokens` | 從供應商快取中讀取的 Token（享受折扣） |
| `cacheWriteTokens` | 寫入快取的 Token（供後續請求使用） |
| `nonCachedPromptTokens` | 未經快取處理的 Token |

### 在交易記錄中

當使用了上游快取時，交易記錄會顯示 **Provider Cache** 標籤：

- **Cache**（天藍色）：平台語義快取命中 - 80% 折扣
- **Provider Cache**（青色）：上游 Prompt 快取命中 - 折扣費率

## 成本計算示例

對於一個向 Claude (Anthropic) 發送的包含 10,000 個輸入 Token 的請求：

**未使用快取：**
```
10,000 tokens × $3.00/1M = $0.030
```

**使用供應商快取（8,000 個已快取 + 2,000 個新 Token）：**
```
快取讀取:  8,000 tokens × $0.30/1M = $0.0024  (1 折)
快取寫入:  2,000 tokens × $3.00/1M = $0.0060
總計: $0.0084 (節省 72%)
```

## 最佳實踐

<AccordionGroup>
  <Accordion title="使用一致的系統 Prompt">
    將系統 Prompt 和靜態上下文放在訊息的開頭。這可以最大化快取命中的可能性。
  </Accordion>

  <Accordion title="批量處理相似請求">
    在短時間內發送具有相同前綴的請求，以便在快取過期前獲益。
  </Accordion>

  <Accordion title="滿足最小 Token 要求">
    確保您的可快取前綴達到供應商的最小值（例如 Anthropic/OpenAI 為 1024 個 Token）。
  </Accordion>

  <Accordion title="監控快取指標">
    查看儀表板中的用量統計，了解快取命中率和節省情況。
  </Accordion>
</AccordionGroup>

## 平台快取 vs 供應商快取

| 維度 | 平台快取 | 供應商快取 |
|--------|----------------|----------------|
| **匹配方式** | 語義相似度 | 精確前綴匹配 |
| **成本** | 正常價格的 20% | 折扣費率 |
| **延遲** | 極低 (~1ms) | 降低（跳過處理過程） |
| **控制方式** | 儀表板設定 | 自動化 |
| **範圍** | 跨用戶（可選） | 基於 API Key |

### 適用場景

```
請求到達
    │
    ▼
┌─────────────────────┐
│ 平台快取命中？       │
└─────────────────────┘
    │ 是               │ 否
    ▼                  ▼
┌─────────┐    ┌─────────────────────┐
│ 返回     │    │ 調用上游 API         │
│ 快取內容 │    └─────────────────────┘
│ (20%)   │            │
└─────────┘            ▼
               ┌─────────────────────┐
               │ 供應商快取命中？     │
               └─────────────────────┘
                   │ 是         │ 否
                   ▼            ▼
               折扣 Token    全額 Token
               費率          費率
```

## 檢查快取狀態

### 回應標頭

```
X-Cache-Status: HIT           # 平台快取命中
X-Cache-Status: MISS          # 無平台快取
X-Upstream-Cache-Read: 8000   # 供應商快取讀取 Token 數
X-Upstream-Cache-Write: 2000  # 供應商快取寫入 Token 數
```

### 用量 API

查詢您的用量日誌以查看快取細分：

```bash
curl https://api.lemondata.cc/v1/usage/logs \
  -H "Authorization: Bearer sk-your-key" \
  -H "Content-Type: application/json"
```

回應包含：
```json
{
  "promptTokens": 10000,
  "cacheReadTokens": 8000,
  "cacheWriteTokens": 2000,
  "nonCachedPromptTokens": 0,
  "completionTokens": 500,
  "cost": 0.0084
}
```

## 常見問題

<AccordionGroup>
  <Accordion title="我可以停用供應商快取嗎？">
    供應商快取是自動的，無法停用。由於它只會為您帶來好處（降低成本），因此沒有理由停用它。
  </Accordion>

  <Accordion title="為什麼我的請求沒有命中供應商快取？">
    常見原因：
    - 前綴已更改（即使只有一個 Token 的差異）
    - 快取已過期（通常為 5-60 分鐘）
    - 前綴太短（低於最小 Token 數）
    - 使用了不同的 API Key
  </Accordion>

  <Accordion title="BYOK 是否支援供應商快取？">
    是的！當使用您自己的 API Key (BYOK) 時，供應商快取的工作方式相同。快取與您的上游 API Key 綁定。
  </Accordion>

  <Accordion title="如何最大化快取節省？">
    1. 對重複的相似查詢使用平台語義快取
    2. 將靜態內容放在 Prompt 結構的前面
    3. 在不同請求之間保持系統 Prompt 的一致性
    4. 快速連續地發送相關請求
  </Accordion>
</AccordionGroup>
