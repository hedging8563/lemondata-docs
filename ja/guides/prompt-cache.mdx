---
title: "✨ 上流プロンプトキャッシュ"
description: "プロバイダーレベルのプロンプトキャッシュとコスト削減の仕組み"
---

## 概要

LemonData の[プラットフォームセマンティックキャッシュ](/guides/caching)に加えて、多くの AI プロバイダーは独自の**プロンプトキャッシュ**機能を提供しています。これはプロバイダーレベル（Anthropic、OpenAI、DeepSeek など）で動作する独立したキャッシュメカニズムです。

<Note>
**2種類のキャッシュ**

| タイプ | 場所 | 仕組み | コスト |
|------|-------|--------------|------|
| **プラットフォームキャッシュ** | LemonData | セマンティック類似度マッチング | 無料（API 呼び出し不要） |
| **プロバイダーキャッシュ** | 上流 (Anthropic/OpenAI など) | 正確なプレフィックスマッチング | トークン料金割引 |

これらは**相互排他的**です：プラットフォームキャッシュがヒットした場合、上流への呼び出しは行われないため、プロバイダーキャッシュは適用されません。
</Note>

## プロバイダープロンプトキャッシュの仕組み

プロバイダープロンプトキャッシュは、プロンプトプレフィックスの処理結果をプロバイダーのサーバーに保存します。同じプレフィックスを持つリクエストを送信すると、プロバイダーはそれらのトークンの再処理をスキップできます。

### 主な特徴

- **プレフィックスベース**：プロンプトの先頭部分のみがキャッシュ可能
- **正確なマッチング**：トークンが完全に一致する必要あり（セマンティック類似ではない）
- **時間制限あり**：キャッシュエントリは期限切れになる（通常 5-60 分）
- **自動化**：特別な設定は不要

```
リクエスト 1: [システムプロンプト + コンテキスト A + 質問 1]
               ^^^^^^^^^^^^^^^^^^^^^^^^
               このプレフィックスがキャッシュされる

リクエスト 2: [システムプロンプト + コンテキスト A + 質問 2]
               ^^^^^^^^^^^^^^^^^^^^^^^^
               キャッシュヒット！質問 2 のみ処理
```

## サポートされているプロバイダー

| プロバイダー | キャッシュ読み取り割引 | キャッシュ書き込みコスト | 最小トークン数 |
|----------|---------------------|------------------|------------|
| **Anthropic** | 90% オフ | 入力と同じ | 1024 |
| **OpenAI** | 50% オフ | 入力と同じ | 1024 |
| **DeepSeek** | 90% オフ | 入力と同じ | 64 |
| **Google** | 75% オフ | 25% 割増 | 32768 |

<Info>
割引は自動的に適用されます。LemonData はプロバイダーのキャッシュ価格をそのまま転送します。
</Info>

## キャッシュ使用状況の確認

### 使用量ログ内

使用量ログには詳細なキャッシュトークンの内訳が表示されます：

| フィールド | 説明 |
|-------|-------------|
| `cacheReadTokens` | プロバイダーキャッシュから読み取られたトークン（割引適用） |
| `cacheWriteTokens` | キャッシュに書き込まれたトークン（後続リクエスト用） |
| `nonCachedPromptTokens` | キャッシュ処理されなかったトークン |

### 取引記録内

上流キャッシュが使用された場合、取引記録には **Provider Cache** タグが表示されます：

- **Cache**（スカイブルー）：プラットフォームセマンティックキャッシュヒット - コストゼロ
- **Provider Cache**（シアン）：上流プロンプトキャッシュヒット - 割引料金

## コスト計算例

Claude (Anthropic) への 10,000 入力トークンを含むリクエストの場合：

**キャッシュなし：**
```
10,000 tokens × $3.00/1M = $0.030
```

**プロバイダーキャッシュ使用（8,000 キャッシュ済み + 2,000 新規トークン）：**
```
キャッシュ読み取り:  8,000 tokens × $0.30/1M = $0.0024  (90% オフ)
キャッシュ書き込み:  2,000 tokens × $3.00/1M = $0.0060
合計: $0.0084 (72% 節約)
```

## ベストプラクティス

<AccordionGroup>
  <Accordion title="一貫したシステムプロンプトを使用">
    システムプロンプトと静的コンテキストをメッセージの先頭に配置します。これによりキャッシュヒットの可能性が最大化されます。
  </Accordion>

  <Accordion title="類似リクエストをバッチ処理">
    同じプレフィックスを持つリクエストを短時間内に送信し、キャッシュが期限切れになる前に恩恵を受けます。
  </Accordion>

  <Accordion title="最小トークン要件を満たす">
    キャッシュ可能なプレフィックスがプロバイダーの最小値（例：Anthropic/OpenAI は 1024 トークン）を満たしていることを確認します。
  </Accordion>

  <Accordion title="キャッシュメトリクスを監視">
    ダッシュボードの使用量統計でキャッシュヒット率と節約額を確認します。
  </Accordion>
</AccordionGroup>

## プラットフォームキャッシュ vs プロバイダーキャッシュ

| 側面 | プラットフォームキャッシュ | プロバイダーキャッシュ |
|--------|----------------|----------------|
| **マッチング方式** | セマンティック類似度 | 正確なプレフィックスマッチング |
| **コスト** | 無料（API 呼び出し不要） | 割引料金 |
| **レイテンシ** | 極めて低い (~1ms) | 低減（処理スキップ） |
| **制御方法** | ダッシュボード設定 | 自動化 |
| **スコープ** | ユーザー間共有（オプション） | API キーベース |

### 適用シナリオ

```
リクエスト到着
    │
    ▼
┌─────────────────────┐
│ プラットフォーム     │
│ キャッシュヒット？   │
└─────────────────────┘
    │ はい             │ いいえ
    ▼                  ▼
┌─────────┐    ┌─────────────────────┐
│ キャッシュ│    │ 上流 API を呼び出し  │
│ 内容を返却│    └─────────────────────┘
│ (無料)   │            │
└─────────┘            ▼
               ┌─────────────────────┐
               │ プロバイダー         │
               │ キャッシュヒット？   │
               └─────────────────────┘
                   │ はい       │ いいえ
                   ▼            ▼
               割引トークン  通常トークン
               料金          料金
```

## キャッシュステータスの確認

### レスポンスヘッダー

```
X-Cache-Status: HIT           # プラットフォームキャッシュヒット
X-Cache-Status: MISS          # プラットフォームキャッシュなし
X-Upstream-Cache-Read: 8000   # プロバイダーキャッシュ読み取りトークン数
X-Upstream-Cache-Write: 2000  # プロバイダーキャッシュ書き込みトークン数
```

### 使用量 API

使用量ログをクエリしてキャッシュの内訳を確認：

```bash
curl https://api.lemondata.cc/v1/usage/logs \
  -H "Authorization: Bearer sk-your-key" \
  -H "Content-Type: application/json"
```

レスポンス内容：
```json
{
  "promptTokens": 10000,
  "cacheReadTokens": 8000,
  "cacheWriteTokens": 2000,
  "nonCachedPromptTokens": 0,
  "completionTokens": 500,
  "cost": 0.0084
}
```

## よくある質問

<AccordionGroup>
  <Accordion title="プロバイダーキャッシュを無効にできますか？">
    プロバイダーキャッシュは自動的で、無効にすることはできません。コスト削減のメリットしかないため、無効にする理由はありません。
  </Accordion>

  <Accordion title="なぜリクエストがプロバイダーキャッシュにヒットしないのですか？">
    一般的な理由：
    - プレフィックスが変更された（1 トークンの違いでも）
    - キャッシュが期限切れ（通常 5-60 分）
    - プレフィックスが短すぎる（最小トークン数未満）
    - 異なる API キーを使用
  </Accordion>

  <Accordion title="BYOK はプロバイダーキャッシュをサポートしていますか？">
    はい！独自の API キー (BYOK) を使用する場合も、プロバイダーキャッシュは同様に機能します。キャッシュは上流の API キーに紐づけられます。
  </Accordion>

  <Accordion title="キャッシュ節約を最大化するには？">
    1. 繰り返しの類似クエリにはプラットフォームセマンティックキャッシュを使用
    2. 静的コンテンツをプロンプト構造の先頭に配置
    3. 異なるリクエスト間でシステムプロンプトの一貫性を維持
    4. 関連リクエストを素早く連続して送信
  </Accordion>
</AccordionGroup>
