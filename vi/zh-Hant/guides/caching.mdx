---
title: "✨ Cache thông minh"
description: "Giảm chi phí và độ trễ thông qua cache ngữ nghĩa nhận biết ngữ cảnh"
---

## Tổng quan

LemonData cung cấp hệ thống cache thông minh giúp giảm đáng kể chi phí API và độ trễ phản hồi của bạn. Cache của chúng tôi không chỉ là khớp yêu cầu đơn giản; nó còn hiểu được **ý nghĩa ngữ nghĩa (semantic meaning)** trong các prompt của bạn.

<CardGroup cols={2}>
  <Card title="Tiết kiệm chi phí" icon="piggy-bank">
    Cache hit chỉ được tính phí bằng một phần nhỏ so với chi phí thông thường.
  </Card>
  <Card title="Phản hồi nhanh hơn" icon="bolt">
    Các phản hồi đã lưu trong cache được trả về ngay lập tức mà không cần thực hiện suy luận mô hình.
  </Card>
  <Card title="Nhận biết ngữ cảnh" icon="brain">
    Khớp ngữ nghĩa tìm thấy các yêu cầu tương tự ngay cả khi cách diễn đạt khác nhau.
  </Card>
  <Card title="Kiểm soát quyền riêng tư" icon="shield">
    Toàn quyền kiểm soát nội dung nào được lưu vào cache và chia sẻ.
  </Card>
</CardGroup>

## Cách thức hoạt động

LemonData sử dụng hệ thống cache hai lớp:

### Lớp 1: Cache phản hồi (Khớp chính xác)

Đối với các yêu cầu có tính xác định (`temperature=0`), chúng tôi lưu cache phản hồi chính xác:

- **Điều kiện khớp**: Cùng model, tin nhắn và tham số
- **Tốc độ**: Tức thì (mili giây)
- **Phù hợp cho**: Các truy vấn lặp lại giống hệt nhau

### Lớp 2: Cache ngữ nghĩa (Khớp tương đồng)

Đối với tất cả các yêu cầu, chúng tôi cũng kiểm tra sự tương đồng về ngữ nghĩa bằng thuật toán khớp hai giai đoạn:

- **Giai đoạn 1 (Chỉ truy vấn)**: Độ tương đồng của truy vấn người dùng ≥95%
- **Giai đoạn 2 (Toàn bộ ngữ cảnh)**: Độ tương đồng bao gồm cả ngữ cảnh hội thoại ≥85%
- **Phù hợp cho**: Các truy vấn dạng FAQ, các câu hỏi thường gặp

```
User A: "What is the capital of France?"
User B: "Tell me the capital city of France"
→ Same cached response (high semantic similarity)
```

## Kiểm soát cache

### Kiểm soát ở cấp độ yêu cầu

Sử dụng tham số `cache_control` trong request body để kiểm soát hành vi cache cho từng yêu cầu:

```bash
# Bỏ qua truy vấn cache, luôn gọi model
curl https://api.lemondata.cc/v1/chat/completions \
  -H "Authorization: Bearer sk-your-key" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "gpt-4o",
    "messages": [{"role": "user", "content": "Hello"}],
    "cache_control": {"type": "no_cache"}
  }'
```

| Loại | Hiệu quả |
|------|------|
| `no_cache` | Bỏ qua truy vấn cache, luôn lấy phản hồi mới |
| `no_store` | Không lưu phản hồi này vào cache |
| `response_only` | Chỉ sử dụng cache khớp chính xác (bỏ qua cache ngữ nghĩa) |
| `semantic_only` | Chỉ sử dụng cache ngữ nghĩa (bỏ qua khớp chính xác) |

### Header phản hồi

Mỗi phản hồi đều bao gồm trạng thái cache:

```
X-Cache-Status: HIT    # Phản hồi đến từ cache
X-Cache-Status: MISS   # Phản hồi mới từ model
```

## Kiểm tra trạng thái cache

```python
from openai import OpenAI

client = OpenAI(
    api_key="sk-your-key",
    base_url="https://api.lemondata.cc/v1"
)

response = client.chat.completions.create(
    model="gpt-4o",
    messages=[{"role": "user", "content": "What is 2+2?"}]
)

# Kiểm tra trạng thái cache từ header phản hồi
# (Có sẵn trong phản hồi HTTP thô)
print(f"Cache: {response._raw_response.headers.get('X-Cache-Status')}")
```

## Tính phí cache

Chi phí cho cache hit thấp hơn đáng kể so với yêu cầu mới:

| Loại | Chi phí |
|------|------|
| Cache hit (HIT) | **Giảm 90% (chỉ còn 10% giá gốc)** |
| Cache miss (MISS) | Giá gốc |

Mức chiết khấu chính xác được hiển thị trong nhật ký sử dụng trên dashboard của bạn.

## Kiểm soát quyền riêng tư

### Cấp độ Tổ chức / Người dùng

Cấu hình hành vi cache trong cài đặt dashboard:

| Chế độ | Mô tả |
|------|-------------|
| **Chia sẻ (Shared)** | Bật cache, phản hồi có thể được chia sẻ giữa các người dùng (mặc định cho tài khoản cá nhân) |
| **Cô lập (Isolated)** | Bật cache, nhưng phản hồi chỉ giới hạn trong tổ chức của bạn (mặc định cho tài khoản tổ chức) |
| **Tắt (Disabled)** | Hoàn toàn không sử dụng cache |

Các mục có thể cấu hình khác:
- **Ngưỡng tương đồng**: Điều chỉnh độ nhạy của khớp ngữ nghĩa (mặc định: 92%)
- **Tùy chỉnh TTL**: Ghi đè thời gian hết hạn của cache
- **Loại trừ model**: Tắt cache cho các model cụ thể

### Cấp độ yêu cầu

Sử dụng tham số `cache_control` để ghi đè cài đặt cho từng yêu cầu đơn lẻ:

```bash
# Tắt cache cho yêu cầu này
curl https://api.lemondata.cc/v1/chat/completions \
  -H "Authorization: Bearer sk-your-key" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "gpt-4o",
    "messages": [{"role": "user", "content": "..."}],
    "cache_control": {"type": "no_store"}
  }'
```

## Phản hồi về cache

Nếu bạn nhận được phản hồi cache sai, bạn có thể báo cáo:

```bash
curl -X POST https://api.lemondata.cc/v1/cache/feedback \
  -H "Authorization: Bearer sk-your-key" \
  -H "Content-Type: application/json" \
  -d '{
    "cache_entry_id": "abc123",
    "feedback_type": "wrong_answer",
    "description": "Response was outdated"
  }'
```

**Loại phản hồi:**
- `wrong_answer` - Sai sót về sự thật
- `outdated` - Thông tin đã lỗi thời
- `irrelevant` - Không liên quan đến câu hỏi
- `other` - Các vấn đề khác

Khi một mục cache nhận đủ số lượng phản hồi tiêu cực, nó sẽ tự động bị vô hiệu hóa.

## Thực hành tốt nhất

<AccordionGroup>
  <Accordion title="Sử dụng temperature=0 cho các truy vấn có thể lưu cache">
    Cài đặt tính xác định giúp tối đa hóa tỷ lệ cache hit.
  </Accordion>

  <Accordion title="Chuẩn hóa định dạng prompt">
    Định dạng nhất quán giúp cải thiện khả năng khớp ngữ nghĩa.
  </Accordion>

  <Accordion title="Sử dụng no-cache cho các truy vấn nhạy cảm với thời gian">
    Các sự kiện hiện tại, dữ liệu thời gian thực nên bỏ qua cache.
  </Accordion>

  <Accordion title="Theo dõi tỷ lệ cache hit">
    Xem thống kê cache và số tiền tiết kiệm được trong dashboard.
  </Accordion>
</AccordionGroup>

## Khi nào không nên sử dụng cache

Tắt cache cho các trường hợp sau:

- **Thông tin thời gian thực**: Giá cổ phiếu, thời tiết, tin tức
- **Nội dung cá nhân hóa**: Đề xuất dành riêng cho một người dùng cụ thể
- **Nhiệm vụ sáng tạo**: Khi cần sự đa dạng trong phản hồi
- **Dữ liệu nhạy cảm**: Thông tin bảo mật

```python
# Đối với các truy vấn nhạy cảm với thời gian
response = client.chat.completions.create(
    model="gpt-4o",
    messages=[{"role": "user", "content": "What's the current stock price of AAPL?"}],
    extra_body={"cache_control": {"type": "no_cache"}}
)
```