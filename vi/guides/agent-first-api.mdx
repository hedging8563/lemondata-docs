---
title: "✨ Agent-First API"
description: "Gợi ý lỗi có cấu trúc giúp các AI agent tự sửa lỗi ngay trong lần thử lại đầu tiên"
---

## Tổng quan

Agent-First API của LemonData làm phong phú các phản hồi lỗi bằng các gợi ý có cấu trúc mà AI agent có thể phân tích và xử lý ngay lập tức — không cần tìm kiếm web, không cần tra cứu tài liệu, không cần đoán mò.

Mỗi phản hồi lỗi bao gồm các trường tùy chọn như `did_you_mean`, `suggestions`, `hint`, `retryable`, và `retry_after` bên trong đối tượng `error` tiêu chuẩn. Các trường này có khả năng tương thích ngược — những client không sử dụng chúng sẽ không thấy sự khác biệt nào.

## Các trường gợi ý lỗi

Tất cả các trường gợi ý là các phần mở rộng tùy chọn bên trong đối tượng `error`:

| Trường | Kiểu dữ liệu | Mô tả |
|-------|------|-------------|
| `did_you_mean` | `string` | Tên mô hình khớp nhất |
| `suggestions` | `array` | Các mô hình được đề xuất kèm theo metadata |
| `alternatives` | `array` | Các mô hình thay thế hiện đang khả dụng |
| `hint` | `string` | Hướng dẫn bước tiếp theo có thể đọc được bởi người/agent |
| `retryable` | `boolean` | Liệu việc thử lại cùng một yêu cầu có thể thành công hay không |
| `retry_after` | `number` | Số giây cần chờ trước khi thử lại |
| `balance_usd` | `number` | Số dư tài khoản hiện tại tính bằng USD |
| `estimated_cost_usd` | `number` | Chi phí ước tính của yêu cầu bị lỗi |

## Ví dụ mã lỗi

### model_not_found (400)

Khi tên mô hình không khớp với bất kỳ mô hình nào đang hoạt động:

```json
{
  "error": {
    "message": "Model 'gpt5' not found",
    "type": "invalid_request_error",
    "param": "model",
    "code": "model_not_found",
    "did_you_mean": "gpt-4o",
    "suggestions": [
      {"id": "gpt-4o"},
      {"id": "gpt-4o-mini"},
      {"id": "claude-sonnet-4-5"}
    ],
    "hint": "Did you mean 'gpt-4o'? Use GET /v1/models to list all available models."
  }
}
```

Việc phân giải `did_you_mean` sử dụng:
1. Ánh xạ alias tĩnh (từ dữ liệu lỗi thực tế)
2. Khớp chuỗi đã chuẩn hóa (loại bỏ dấu gạch ngang, không phân biệt chữ hoa chữ thường)
3. Khớp khoảng cách chỉnh sửa (ngưỡng ≤ 3)

### insufficient_balance (402)

Khi số dư tài khoản quá thấp so với chi phí ước tính:

```json
{
  "error": {
    "message": "Insufficient balance: need ~$0.3500 for claude-sonnet-4-5, but balance is $0.1200.",
    "type": "insufficient_balance",
    "code": "insufficient_balance",
    "balance_usd": 0.12,
    "estimated_cost_usd": 0.35,
    "suggestions": [
      {"id": "gpt-4o-mini"},
      {"id": "deepseek-chat"}
    ],
    "hint": "Insufficient balance: need ~$0.3500 for claude-sonnet-4-5, but balance is $0.1200. Try a cheaper model, or top up at https://lemondata.cc/dashboard/billing."
  }
}
```

`suggestions` chứa các mô hình rẻ hơn chi phí ước tính mà agent có thể chuyển sang.

### all_channels_failed (503)

Khi tất cả các kênh upstream của một mô hình không khả dụng:

```json
{
  "error": {
    "message": "Model claude-opus-4-6 temporarily unavailable",
    "code": "all_channels_failed",
    "retryable": true,
    "retry_after": 30,
    "alternatives": [
      {"id": "claude-sonnet-4-5", "status": "available", "tags": []},
      {"id": "gpt-4o", "status": "available", "tags": []}
    ],
    "hint": "All channels for 'claude-opus-4-6' are temporarily unavailable. Retry in 30s or try an alternative model."
  }
}
```

<Note>
`retryable` là `false` khi lý do là `no_channels` (không có kênh nào được cấu hình cho mô hình này). Nó chỉ là `true` đối với các lỗi tạm thời như ngắt mạch (circuit breaker) hoặc hết hạn mức (quota).
</Note>

### rate_limit_exceeded (429)

```json
{
  "error": {
    "message": "Rate limit: 60 rpm exceeded",
    "type": "rate_limit_error",
    "code": "rate_limit_exceeded",
    "retryable": true,
    "retry_after": 8,
    "hint": "Rate limited. Retry after 8s. Current limit: 60/min for user role."
  }
}
```

Giá trị `retry_after` được tính toán từ thời gian reset cửa sổ giới hạn tốc độ thực tế.

### context_length_exceeded (400)

Khi đầu vào vượt quá cửa sổ ngữ cảnh của mô hình (lỗi upstream, được bổ sung thêm gợi ý):

```json
{
  "error": {
    "message": "This model's maximum context length is 128000 tokens...",
    "type": "invalid_request_error",
    "code": "context_length_exceeded",
    "retryable": false,
    "suggestions": [
      {"id": "gemini-2.5-pro"},
      {"id": "claude-sonnet-4-5"}
    ],
    "hint": "Reduce your input or switch to a model with a larger context window."
  }
}
```

## Native Endpoint Headers

Khi bạn gọi `/v1/chat/completions` với một mô hình có endpoint gốc (Anthropic hoặc Gemini), **phản hồi thành công** sẽ bao gồm các header tối ưu hóa:

```
X-LemonData-Hint: This model supports native Anthropic format. Use POST /v1/messages for better performance (no format conversion).
X-LemonData-Native-Endpoint: /v1/messages
```

| Nhà cung cấp mô hình | Endpoint đề xuất | Lợi ích |
|---------------|-------------------|---------|
| Anthropic (Claude) | `/v1/messages` | Không chuyển đổi định dạng, extended thinking, prompt caching |
| Google (Gemini) | `/v1beta/gemini` | Không chuyển đổi định dạng, grounding, thiết lập an toàn |
| OpenAI | — | Chat completions đã là định dạng gốc |

Các header này xuất hiện trên cả phản hồi streaming và non-streaming.

## Cải tiến /v1/models

Ba trường mới trong phần mở rộng `lemondata` của mỗi đối tượng mô hình:

```json
{
  "id": "gpt-4o",
  "lemondata": {
    "category": "chat",
    "pricing_unit": "per_token",
    "cache_pricing": {
      "cache_read_per_1m": "1.25",
      "cache_write_per_1m": "2.50",
      "platform_cache_discount": 0.9
    }
  }
}
```

| Trường | Giá trị | Mô tả |
|-------|--------|-------------|
| `category` | `chat`, `image`, `video`, `audio`, `tts`, `stt`, `3d`, `embedding`, `rerank` | Loại mô hình |
| `pricing_unit` | `per_token`, `per_image`, `per_second`, `per_request` | Cách tính phí mô hình |
| `cache_pricing` | đối tượng hoặc `null` | Giá prompt cache upstream + chiết khấu semantic cache của nền tảng |

### Lọc theo danh mục (Category Filtering)

```bash
GET /v1/models?category=chat          # Chỉ các mô hình chat
GET /v1/models?category=image         # Các mô hình tạo ảnh
GET /v1/models?tag=coding&category=chat  # Các mô hình chat tối ưu cho lập trình
```

## llms.txt

Bản tóm tắt API có thể đọc được bằng máy có sẵn tại:

```
GET https://api.lemondata.cc/llms.txt
```

Nó bao gồm:
- Template cho lần gọi đầu tiên với ví dụ thực tế
- Tên các mô hình phổ biến (được tạo động từ dữ liệu sử dụng)
- Tất cả 12 API endpoint
- Các tham số lọc để khám phá mô hình
- Hướng dẫn xử lý lỗi

Các AI agent đọc `llms.txt` trước lần gọi API đầu tiên thường có thể thành công ngay trong lần thử đầu.

## Sử dụng trong mã nguồn Agent

### Python (OpenAI SDK)

```python
from openai import OpenAI, BadRequestError

client = OpenAI(
    api_key="sk-your-key",
    base_url="https://api.lemondata.cc/v1"
)

def smart_chat(messages, model="gpt-4o"):
    try:
        return client.chat.completions.create(
            model=model, messages=messages
        )
    except BadRequestError as e:
        error = e.body.get("error", {}) if isinstance(e.body, dict) else {}
        # Sử dụng did_you_mean để tự động sửa lỗi
        if error.get("code") == "model_not_found" and error.get("did_you_mean"):
            return client.chat.completions.create(
                model=error["did_you_mean"], messages=messages
            )
        raise
```

### JavaScript (OpenAI SDK)

```javascript
import OpenAI from 'openai';

const client = new OpenAI({
  apiKey: 'sk-your-key',
  baseURL: 'https://api.lemondata.cc/v1'
});

async function smartChat(messages, model = 'gpt-4o') {
  try {
    return await client.chat.completions.create({ model, messages });
  } catch (error) {
    const err = error?.error;
    if (err?.code === 'model_not_found' && err?.did_you_mean) {
      return client.chat.completions.create({
        model: err.did_you_mean, messages
      });
    }
    throw error;
  }
}
```

## Nguyên tắc thiết kế

<CardGroup cols={2}>
  <Card title="Thất bại nhanh, thông báo chi tiết" icon="bolt">
    Lỗi được trả về ngay lập tức với đầy đủ dữ liệu cần thiết để agent tự sửa lỗi.
  </Card>
  <Card title="Không tự động điều hướng" icon="route">
    API không bao giờ âm thầm thay thế bằng một mô hình khác. Agent là bên quyết định.
  </Card>
  <Card title="Gợi ý dựa trên dữ liệu" icon="database">
    Tất cả các đề xuất đều đến từ dữ liệu thực tế, không phải từ danh sách được mã hóa cứng.
  </Card>
  <Card title="Tương thích ngược" icon="plug">
    Tất cả các trường gợi ý là tùy chọn. Các client hiện tại sẽ không thấy sự khác biệt.
  </Card>
</CardGroup>